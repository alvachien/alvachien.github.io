---
layout: post
title:  "Maven浅窥"
date:   2020-11-20 22:23:22 +0800
tags: [Maven, Java]
categories: [技术Tips]
---

Maven某种程度上跟NPM类似，都是软件项目中包依赖解决方案。


### 下载与配置

跟NPM需要安装node.js不同，Maven只需要下载和配置就能使用。


首先，去[官方网站](https://maven.apache.org/)去下载。


以Windows系统为例，下载并解压缩到选定的文件夹(/install_dir/)。配置系统变量：
```ini
M2_HOME=/install_dir/
```

同时，更新系统变量Path   
```ini
Path=$PATH:$M2_HOME/bin
```

确认下配置成功：   
```PowerShell
mvn -version
```


输出结果：   
```
Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)
Maven home: D:\Tools\apache-maven-3.6.3\bin\..
Java version: 15.0.1, vendor: Oracle Corporation, runtime: D:\Tools\jdk-15.0.1
Default locale: en_US, platform encoding: GBK
OS name: "windows 10", version: "10.0", arch: "amd64", family: "windows"
```


### 一个典型的Maven项目

一个典型的Maven项目结构：  

maven-based-project   
├── pom.xml   
├── src   
│   ├── main   
│   │   ├── java   
│   │   └── resources   
│   └── test   
│       ├── java   
│       └── resources   
└── target   

各文件和目录说明如下：  
- 项目描述文件 pom.xml;
- 源码目录： src/main/java;
- 项目资源目录： src/main/resources;
- 测试代码目录： src/test/java
- 测试资源目录： src/test/resources
- 编译、打包输出目录：target

#### 项目描述文件

一个典型的项目描述文件：   

```xml
<project ...>
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.alvachien</groupId>
	<artifactId>myproject</artifactId>
	<version>1.0</version>
	<packaging>jar</packaging>
	<properties>
        ...
	</properties>
	<dependencies>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
            <version>5.3.2</version>
            <scope>test</scope>
        </dependency>
	</dependencies>
</project>
```

##### 项目包的逻辑key

与NPM中使用名称和Version作为唯一标识来确定dependence类似，Maven中依赖管理的逻辑key是：   
- **groupId**，属于组织的名称
- **artifactId**，该jar包自身的名称
- **version**，该jar包的版本。注意，-SNAPSHOT结尾的版本会被Maven视为开发版本。


同样，在项目描述文件中，上述三个逻辑key也用作项目描述文件的关键信息。  

##### 依赖关系范围

Maven的依赖关系范围：   

|scope|说明|
|---|---|   
|compile|(默认)编译范围，只在编译时用到该依赖|   
|test|编译test时需要用到该依赖。典型的runtime是JUnit|    
|runtime|编译时不需要该依赖，运行时需要。典型runtime是JDBC驱动，如MySQL|   
|provided|编译时用到该依赖，但运行时由JDK或某个服务器提供。典型的provided依赖是Servlet API|   

##### Maven下载与国内镜像

当Maven进行编译或测试时候，Maven会自动下载依赖的包。基于国情，指定使用国内镜像还是很有必要的。Windows系统下，在用户主目录下创建.m2目录，创建一个settings.xml配置文件：

```xml
<settings>
    <mirrors>
        <mirror>
            <id>aliyun</id>
            <name>aliyun</name>
            <mirrorOf>central</mirrorOf>
            <!-- 国内推荐阿里云的Maven镜像 -->
            <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
        </mirror>
    </mirrors>
</settings>
```

#### 编译Maven项目

在根目录下（即pom.xml所在目录），可以直接进行编译：   

```PowerShell
mvn clean package
```

这样，所有文件被编译，并输出到target目录。


### Maven的生命周期 （lifecyle）

常见的Maven的生命周期有两个：default和clean。

Maven的生命周期由一系列阶段（Phase）构成。而Phrase则对应了一个或多个Goal。常见的Phrase对应的goal如下：

|Phase|对应的Goal|
|--|--|
|compile|compiler:compile|
|test|compiler:testCompile;surefire:test|

执行每个phase，都是通过某个插件（plugin）来执行的，Maven本身其实并不知道如何执行compile，它只是负责找到对应的compiler插件，然后执行默认的compiler:compile这个goal来完成编译。

使用Maven，实际上就是配置好需要使用的插件，然后通过phase调用它们。   

|Plugin|对应执行Phase|
|--|--|
|clean|clean|
|compiler|compile|
|surefire|test|
|jar|package|


如果标准插件无法满足需求，我们还可以使用自定义插件。 一些常用的插件：   
- maven-shade-plugin：打包所有依赖包并生成可执行jar；
- cobertura-maven-plugin：生成单元测试覆盖率报告；
- findbugs-maven-plugin：对Java源码进行静态分析以找出潜在问题。


#### Maven的default生命周期

它包含了如下的阶段（phase）：

- validate
- initialize
- generate-sources
- process-sources
- generate-resources
- process-resources
- compile
- process-classes
- generate-test-sources
- process-test-sources
- generate-test-resources
- process-test-resources
- test-compile
- process-test-classes
- test
- prepare-package
- package
- pre-integration-test
- integration-test
- post-integration-test
- verify
- install
- deploy


#### Maven的clean生命周期

它包含了如下的阶段：   
- pre-clean
- clean
- post-clean


#### 常见的Maven的命令

常见的Maven如下：  

- mvn clean: 执行clean生命周期中的phrase，主要用于清理所有生成的class和jar；
- mvn clean compile：先执行clean生命周期，再执行default生命周期到compile的phrase；
- mvn clean test：先执行clean生命周期，再执行default生命周期到test的phrase；
- mvn clean package：先执行clean生命周期，再执行default生命周期到package的phrase；

### 复杂项目的模块管理

复杂项目结构下，通常需要把公共部分提出来放在一个公用目录parent下：

complex-project    
├── pom.xml   
├── parent   
│   └── pom.xml   
├── module-a   
│   ├── pom.xml   
│   └── src    
├── module-b   
│   ├── pom.xml    
│   └── src     
└── module-c     
    ├── pom.xml     
    └── src     

这样，parent目录下的pom如下(其packaging是pom)：   

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.alvachien.learnjava</groupId>
    <artifactId>parent</artifactId>
    <version>1.0</version>
    <packaging>pom</packaging>

    <name>parent</name>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
        <java.version>11</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-engine</artifactId>
            <version>5.5.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

module-a目录下的POM如下：

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.alvachien.learnjava</groupId>
        <artifactId>parent</artifactId>
        <version>1.0</version>
        <relativePath>../parent/pom.xml</relativePath>
    </parent>

    <artifactId>module-a</artifactId>
    <packaging>jar</packaging>
    <name>module-a</name>
</project>
```

假设model-b依赖model-a，则其pom如下：   
```xml
    ...
    <dependencies>
        <dependency>
            <groupId>com.alvachien.learnjava</groupId>
            <artifactId>module-a</artifactId>
            <version>1.0</version>
        </dependency>
    </dependencies>
```

而根目录下的pom如下：   

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">

    <modelVersion>4.0.0</modelVersion>
    <groupId>com.alvachien.learnjava</groupId>
    <artifactId>build</artifactId>
    <version>1.0</version>
    <packaging>pom</packaging>
    <name>build</name>

    <modules>
        <module>parent</module>
        <module>module-a</module>
        <module>module-b</module>
    </modules>
</project>
```
